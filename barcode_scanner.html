<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>條碼掃描器</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        /* 全局設置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 20px;
            padding: 20px; /* Simplified padding */
        }

        /* 標題區塊 */
        .header {
            background: linear-gradient(135deg, #007AFF, #0056b3);
            color: white;
            padding: 25px 20px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            border-radius: 8px 8px 0 0; /* Match container top corners */
            margin: -20px -20px 20px -20px; /* Adjust to container padding */
        }

        /* 掃描器視訊容器 */
        .scanner-container {
            position: relative;
            margin-bottom: 25px;
            border-radius: 10px;
            overflow: hidden;
            background: #f5f5f5;
            min-height: 250px; /* Minimum height for video */
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #ddd;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover; /* Ensures video fills container */
            border-radius: 10px;
        }

        /* 紅色掃描線疊層 */
        #red-line {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%; /* 掃描線寬度 */
            height: 2px;
            background-color: #FF3B30; /* 鮮紅色 */
            box-shadow: 0 0 10px rgba(255, 59, 48, 0.7);
            z-index: 10;
            pointer-events: none; /* Allows clicks to pass through */
            border-radius: 2px;
        }

        /* 控制按鈕區塊 */
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            background-color: #007AFF;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .btn.stop {
            background-color: #FF3B30; /* 紅色停止按鈕 */
        }
        .btn.stop:hover {
            background-color: #D70015;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 狀態訊息 */
        #status-message {
            text-align: center;
            margin-bottom: 0; /* No margin below if it's the last element */
            font-size: 1.1rem;
            color: #666;
            min-height: 25px; /* Prevent layout shift */
            word-break: break-all; /* Ensure long results fit */
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-top: 20px; /* Add margin to separate from controls */
        }

        .status-ready { color: #34C759; } /* 綠色 */
        .status-scanning { color: #007AFF; } /* 藍色 */
        .status-error { color: #FF3B30; } /* 紅色 */
        .status-info { color: #FF9500; } /* 橙色 */


        /* 響應式調整 */
        @media (max-width: 500px) {
            body {
                padding: 10px;
            }
            .container {
                border-radius: 0;
            }
            .header {
                font-size: 1.5rem;
                padding: 20px 10px;
            }
            .btn {
                padding: 10px 18px;
                font-size: 15px;
                min-width: 100px;
            }
            #status-message {
                font-size: 1rem;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">條碼掃描器</div>
        
        <div class="scanner-container">
            <video id="video" autoplay muted playsinline></video>
            <div id="red-line"></div>
        </div>
        
        <div class="controls">
            <button id="toggle-scan-btn" class="btn">🎯 開始掃描</button>
            <button id="rescan-btn" class="btn">🔄 重新掃描</button>
        </div>
        
        <div id="status-message">📋 準備就緒，點擊開始掃碼</div>
    </div>

    <script>
        class BarcodeScannerApp {
            constructor() {
                // ZXing Code Reader 實例，只掃描 CODE_128 格式
                this.codeReader = new ZXing.BrowserMultiFormatReader(null, {
                    formats: [ZXing.BarcodeFormat.CODE_128]
                });
                
                // DOM 元素引用
                this.videoElement = document.getElementById('video');
                this.toggleScanBtn = document.getElementById('toggle-scan-btn');
                this.rescanBtn = document.getElementById('rescan-btn');
                this.statusMessageElement = document.getElementById('status-message');

                this.isScanning = false;  // 掃描狀態

                this.bindEvents();
                this.updateToggleButtonState();
            }

            // 綁定事件監聽器
            bindEvents() {
                this.toggleScanBtn.addEventListener('click', this.toggleScan.bind(this));
                this.rescanBtn.addEventListener('click', this.rescan.bind(this));
                
                // 處理頁面不可見時停止相機，避免後台佔用資源
                document.addEventListener('visibilitychange', this.handleVisibilityChange.bind(this));
            }

            // 更新按鈕狀態和文字
            updateToggleButtonState() {
                if (this.isScanning) {
                    this.toggleScanBtn.textContent = '⏹️ 停止掃描';
                    this.toggleScanBtn.classList.add('stop');
                    this.rescanBtn.disabled = true; // 掃描中禁用重新掃描
                } else {
                    this.toggleScanBtn.textContent = '🎯 開始掃描';
                    this.toggleScanBtn.classList.remove('stop');
                    this.rescanBtn.disabled = false; // 停止時啟用重新掃描
                }
            }

            // 更新狀態訊息
            updateStatus(message, type = 'ready') {
                this.statusMessageElement.textContent = message;
                this.statusMessageElement.className = `status-message status-${type}`;
            }

            // 啟動掃描
            async startScan() {
                if (this.isScanning) return;

                this.updateStatus('🔍 正在啟動相機...', 'info');
                this.updateToggleButtonState(); // 立即更新按鈕狀態

                // 直接定義傳遞給 getUserMedia 的完整約束條件
                const mediaStreamConstraints = {
                    video: { // 請求視訊，並指定理想解析度
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'environment' // <--- 添加這一行，指定為後置相機
                    },
                    audio: false // 明確指定不請求音訊
                };

                try {
                    // 直接呼叫 getUserMedia 取得視訊流
                    const stream = await navigator.mediaDevices.getUserMedia(mediaStreamConstraints);
                    this.videoElement.srcObject = stream; // 將視訊流設定到 <video> 元素

                    // 現在，使用 ZXing 的 decodeFromStream 方法從取得的視訊流中解碼
                    await this.codeReader.decodeFromStream(
                        stream, // 將視訊流直接傳遞給 ZXing
                        this.videoElement,
                        (result, err) => {
                            if (result) {
                                // 確保只處理 CODE_128 格式
                                if (result.getBarcodeFormat().toString() === 'CODE_128') {
                                    const scannedCode = result.getText();
                                    this.updateStatus(`✅ 掃描成功: ${scannedCode}`, 'ready');
                                    this.playBeep(); // 播放提示音
                                    this.stopScan(); // 成功掃描後立即停止
                                }
                            }

                            // 忽略 NotFoundException（沒有掃描到條碼是正常現象）
                            if (err && !(err instanceof ZXing.NotFoundException)) {
                                console.error("掃描錯誤:", err);
                                this.updateStatus(`❌ 掃描錯誤: ${err.name || err.message}`, 'error');
                                this.stopScan(); // 停止掃描以避免無限錯誤
                            }
                        }
                    );
                    this.isScanning = true;
                    this.updateStatus('📸 相機已啟動，請對準條碼', 'scanning');
                    this.updateToggleButtonState();
                    console.log("ZXing 相機已啟動並開始解碼...");

                } catch (err) {
                    console.error("無法啟動相機:", err);
                    let errorMessage = "❌ 無法啟動相機，請確認權限設定。";

                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMessage = "❌ 需相機權限，請點擊網址列的相機圖標允許。";
                    } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                        errorMessage = "❌ 未找到相機設備。請確認您的筆電有相機。";
                    } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                        errorMessage = "❌ 相機被佔用或無法啟動，請關閉其他程式。";
                    } else if (err.name === 'OverconstrainedError') {
                        errorMessage = "❌ 相機配置衝突，請嘗試調整裝置設定。";
                    } else if (err.name === 'SecurityError') {
                         errorMessage = "❌ 網頁需透過 HTTPS 或 localhost 運行才能啟動相機。";
                    }
                    this.updateStatus(errorMessage, 'error');
                    this.isScanning = false;
                    this.updateToggleButtonState();
                }
            }

            // 停止掃描
            async stopScan() {
                if (!this.isScanning) return; // 如果已經停止，則不執行

                // 停止視訊流軌道
                const stream = this.videoElement.srcObject;
                if (stream) {
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop()); // 停止所有軌道
                }

                this.codeReader.reset(); // 停止解碼並釋放相機資源
                this.isScanning = false;
                this.videoElement.srcObject = null; // 清空視訊流
                this.updateStatus('📋 掃描已停止', 'ready');
                this.updateToggleButtonState();
                console.log("ZXing 相機已停止。");
            }

            // 切換掃描狀態 (開始/停止)
            toggleScan() {
                if (this.isScanning) {
                    this.stopScan();
                } else {
                    this.startScan();
                }
            }

            // 重新掃描 (停止後再啟動)
            async rescan() {
                // 如果當前正在掃描，先停止
                if (this.isScanning) {
                    await this.stopScan();
                }
                this.updateStatus('🔄 重新啟動掃描中...', 'info');
                // 重新啟動掃描
                await this.startScan();
            }
            
            // 播放提示音
            playBeep() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800; // 頻率
                    oscillator.type = 'sine'; // 正弦波
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1); // 快速衰減
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (e) {
                    console.warn("無法播放提示音:", e);
                }
            }

            // 處理頁面可見性改變（切換標籤頁等）
            handleVisibilityChange() {
                if (document.hidden && this.isScanning) {
                    this.stopScan();
                    this.updateStatus('頁面已切換，掃描自動停止', 'info');
                }
            }
        }

        // 頁面載入完成後初始化應用程式
        document.addEventListener('DOMContentLoaded', () => {
            const scannerApp = new BarcodeScannerApp();
            scannerApp.startScan(); // 自動啟動掃碼
        });
    </script>
</body>
</html>
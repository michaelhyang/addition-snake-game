<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¢ç¢¼æƒæå™¨ (QuaggaJS2)</title>
    <style>
        /* å…¨å±€è¨­ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 20px;
            padding: 20px;
        }

        /* æ¨™é¡Œå€å¡Š */
        .header {
            background: linear-gradient(135deg, #007AFF, #0056b3);
            color: white;
            padding: 25px 20px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 20px -20px;
        }

        /* æƒæå™¨è¦–è¨Šå®¹å™¨ */
        .scanner-container {
            position: relative;
            margin-bottom: 25px;
            border-radius: 10px;
            overflow: hidden;
            background: #f5f5f5;
            /* ç§»é™¤ min-heightï¼Œè®“ #reader å…§éƒ¨å…ƒç´ æ±ºå®šé«˜åº¦ */
            /* min-height: 250px; */ 
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #ddd;
        }

        /* QuaggaJS2 å°‡åœ¨ #reader é€™å€‹ div å…§æ¸²æŸ“å®ƒçš„ç›¸æ©Ÿç•«é¢å’Œ UI */
        #reader {
            width: 100%;
            /* ä½¿ç”¨ padding-top ä¾†ç¶­æŒ 16:9 çš„é•·å¯¬æ¯” */
            padding-top: 56.25%; /* (9 / 16) * 100% = 56.25% */
            position: relative; 
            overflow: hidden; /* ç¢ºä¿å…§å®¹ä¸æº¢å‡º */
        }
        
        /* QuaggaJS2 ç”Ÿæˆçš„è¦–è¨Šå’Œç•«å¸ƒå…ƒç´ æ¨£å¼èª¿æ•´ */
        #reader video, #reader canvas {
            width: 100%;
            height: 100%; /* å¡«å……çˆ¶å®¹å™¨çš„é«˜åº¦ */
            display: block;
            border-radius: 10px;
            position: absolute;
            top: 0;
            left: 0;
            object-fit: cover; /* ç¢ºä¿è¦–è¨Šå…§å®¹å¡«æ»¿å®¹å™¨è€Œä¸è®Šå½¢ */
        }
        /* å¦‚æœ Quagga æ²’æœ‰åˆå§‹åŒ–æˆåŠŸï¼Œä¿æŒå®¹å™¨å¯è¦‹ */
        #reader:empty {
            min-height: 250px; /* ä¿æŒé ç•™ç©ºé–“ */
            background-color: #f5f5f5; /* èƒŒæ™¯è‰² */
        }

        /* ç´…è‰²å°æº–ç·š */
        .scan-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px; /* ç·šçš„ç²—ç´° */
            background-color: #FF3B30; /* ç´…è‰² */
            transform: translateY(-50%);
            z-index: 2; /* ç¢ºä¿åœ¨ video å’Œ canvas ä¹‹ä¸Š */
            box-shadow: 0 0 10px rgba(255, 59, 48, 0.7); /* ç™¼å…‰æ•ˆæœ */
            width: 80%; /* ç·šçš„å¯¬åº¦ï¼Œå¯èª¿æ•´ */
            margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
        }
        /* æƒæç·šå‹•ç•« (å¯é¸) */
        .scan-line.active {
             animation: scanline-pulse 1.5s infinite alternate;
        }
        @keyframes scanline-pulse {
            from { opacity: 0.8; transform: translateY(-50%) scaleX(1); }
            to { opacity: 1; transform: translateY(-50%) scaleX(1.02); }
        }

        /* æ–°å¢çš„å°ç„¦æ¡† */
        .focus-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%; /* æ¡†çš„å¯¬åº¦ */
            height: 100px; /* æ¡†çš„é«˜åº¦ï¼Œæ ¹æ“šæ¢ç¢¼é¡å‹èª¿æ•´ */
            border: 2px dashed rgba(255, 255, 255, 0.7); /* ç™½è‰²è™›ç·šæ¡† */
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); /* é®ç½©æ•ˆæœ */
            z-index: 1; /* åœ¨ scan-line ä¸‹æ–¹ï¼Œåœ¨ video/canvas ä¸Šæ–¹ */
            border-radius: 8px; /* åœ“è§’ */
        }
        /* å¦‚æœæƒææ²’æœ‰å•Ÿå‹•ï¼Œéš±è—å°ç„¦æ¡†å’Œç´…ç·š */
        .scan-elements-hidden .scan-line,
        .scan-elements-hidden .focus-box {
            display: none;
        }


        /* æ§åˆ¶æŒ‰éˆ•å€å¡Š */
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            background-color: #007AFF;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .btn.stop {
            background-color: #FF3B30;
        }
        .btn.stop:hover {
            background-color: #D70015;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn.clear-all {
            background-color: #6C757D;
        }
        .btn.clear-all:hover {
            background-color: #5A6268;
        }

        /* ç‹€æ…‹è¨Šæ¯ */
        #status-message {
            text-align: center;
            margin-bottom: 0;
            font-size: 1.1rem;
            color: #666;
            min-height: 25px;
            word-break: break-all;
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-top: 20px;
        }

        .status-ready { color: #34C759; }
        .status-scanning { color: #007AFF; }
        .status-error { color: #FF3B30; }
        .status-info { color: #FF9500; }

        /* æƒæçµæœé¡¯ç¤ºå€å¡Š */
        .scanned-results-container {
            margin-top: 25px;
            background: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        #scanned-results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            word-break: break-all;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-item .content {
            flex-grow: 1;
            margin-right: 10px;
        }
        .result-item .content strong {
            display: block;
            font-size: 1.1rem;
            color: #333;
        }
        .result-item .content span {
            font-size: 0.85rem;
            color: #777;
        }

        .result-item .delete-btn {
            background-color: #FF3B30;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .result-item .delete-btn:hover {
            background-color: #D70015;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 500px) {
            body {
                padding: 10px;
            }
            .container {
                border-radius: 0;
            }
            .header {
                font-size: 1.5rem;
                padding: 20px 10px;
            }
            .btn {
                padding: 10px 18px;
                font-size: 15px;
                min-width: 100px;
            }
            #status-message {
                font-size: 1rem;
                padding: 12px;
            }
            .scan-line {
                width: 90%;
            }
            .focus-box {
                width: 85%;
                height: 90px;
            }
            .result-item {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            .result-item .content strong {
                font-size: 1rem;
            }
            .result-item .delete-btn {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">æ¢ç¢¼æƒæå™¨</div>
        
        <div class="scanner-container" id="scanner-container">
            <div id="reader"></div> <div class="scan-line" id="scan-line"></div> <div class="focus-box" id="focus-box"></div> </div>
        
        <div class="controls">
            <button id="toggle-scan-btn" class="btn">ğŸ¯ é–‹å§‹æƒæ</button>
            <button id="rescan-btn" class="btn">ğŸ”„ é‡æ–°æƒæ</button>
            <button id="clear-all-btn" class="btn clear-all">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
        </div>
        
        <div id="status-message">ğŸ“‹ æº–å‚™å°±ç·’ï¼Œé»æ“Šé–‹å§‹æƒç¢¼</div>

        <div class="scanned-results-container">
            <h3>æƒæçµæœ</h3>
            <ul id="scanned-results-list">
                <li style="text-align: center; color: #888;">æš«ç„¡æƒæçµæœ</li>
            </ul>
        </div>
    </div>

    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
        class BarcodeScannerApp {
            constructor() {
                this.toggleScanBtn = document.getElementById('toggle-scan-btn');
                this.rescanBtn = document.getElementById('rescan-btn');
                this.clearAllBtn = document.getElementById('clear-all-btn');
                this.statusMessageElement = document.getElementById('status-message');
                this.scanLineElement = document.getElementById('scan-line');
                this.focusBoxElement = document.getElementById('focus-box'); // æ–°å¢å°ç„¦æ¡†å…ƒç´ 
                this.scannedResultsList = document.getElementById('scanned-results-list');
                this.scannerContainer = document.getElementById('scanner-container'); // å–å¾— scanner-container å…ƒç´ 

                this.isScanning = false;
                this.lastDetectedCode = null;
                this.results = [];
                this.nextResultId = 0;

                this.bindEvents();
                this.updateToggleButtonState();
                this.loadResultsFromLocalStorage();
                this.renderResults();
            }

            bindEvents() {
                this.toggleScanBtn.addEventListener('click', this.toggleScan.bind(this));
                this.rescanBtn.addEventListener('click', this.rescan.bind(this));
                this.clearAllBtn.addEventListener('click', this.clearAllResults.bind(this));
                document.addEventListener('visibilitychange', this.handleVisibilityChange.bind(this));
            }

            updateToggleButtonState() {
                if (this.isScanning) {
                    this.toggleScanBtn.textContent = 'â¹ï¸ åœæ­¢æƒæ';
                    this.toggleScanBtn.classList.add('stop');
                    this.rescanBtn.disabled = true;
                    this.scanLineElement.classList.add('active');
                    // æƒæä¸­é¡¯ç¤ºæƒæç·šå’Œå°ç„¦æ¡†
                    this.scannerContainer.classList.remove('scan-elements-hidden');
                } else {
                    this.toggleScanBtn.textContent = 'ğŸ¯ é–‹å§‹æƒæ';
                    this.toggleScanBtn.classList.remove('stop');
                    this.rescanBtn.disabled = false;
                    this.scanLineElement.classList.remove('active');
                    // æƒæåœæ­¢æ™‚éš±è—æƒæç·šå’Œå°ç„¦æ¡†
                    this.scannerContainer.classList.add('scan-elements-hidden');
                }
            }

            updateStatus(message, type = 'ready') {
                this.statusMessageElement.textContent = message;
                this.statusMessageElement.className = `status-message status-${type}`;
            }

            async startScan() {
                if (this.isScanning) return;

                this.updateStatus('ğŸ” æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...', 'info');
                this.updateToggleButtonState();

                const config = {
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#reader'),
                        constraints: {
                            // ä¿æŒç†æƒ³è§£æåº¦ï¼Œè®“ç€è¦½å™¨é¸æ“‡æœ€æ¥è¿‘çš„
                            width: { ideal: 1280 }, 
                            height: { ideal: 720 },
                            facingMode: "environment"
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true,
                        locate: true, 
                    },
                    decoder: {
                        readers: [
                            "code_128_reader",
                        ]
                    }
                };

                try {
                    Quagga.init(config, (err) => {
                        if (err) {
                            this.handleCameraError(err);
                            return;
                        }
                        Quagga.onDetected((result) => this.onScanSuccess(result));
                        Quagga.start();
                        this.isScanning = true;
                        this.updateStatus('ğŸ“¸ ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œè«‹å°æº–æ¢ç¢¼', 'scanning');
                        this.updateToggleButtonState();
                    });

                } catch (err) {
                    this.handleCameraError(err);
                }
            }

            onScanSuccess(result) {
                if (result && result.codeResult && result.codeResult.code) {
                    const decodedText = result.codeResult.code;
                    const format = result.codeResult.format;

                    if (this.lastDetectedCode === decodedText) {
                        return;
                    }

                    this.lastDetectedCode = decodedText;
                    
                    setTimeout(() => {
                        this.lastDetectedCode = null;
                    }, 1000); // 1 ç§’å…§ä¸é‡è¤‡è­˜åˆ¥

                    this.playBeep();
                    this.updateStatus(`âœ… æƒææˆåŠŸ: ${decodedText}`, 'scanning'); 
                    this.addResultToDisplay(decodedText, format);
                }
            }

            onScanError(errorMessage) {
                // QuaggaJS2 æ²’æœ‰é€£çºŒçš„ onScanError å›å‘¼
            }

            handleCameraError(err) {
                console.error("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ:", err);
                let errorMessage = "âŒ ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®šã€‚";

                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage = "âŒ éœ€ç›¸æ©Ÿæ¬Šé™ï¼Œè«‹é»æ“Šç¶²å€åˆ—çš„ç›¸æ©Ÿåœ–æ¨™å…è¨±ã€‚";
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMessage = "âŒ æœªæ‰¾åˆ°ç›¸æ©Ÿè¨­å‚™ã€‚è«‹ç¢ºèªæ‚¨çš„è£ç½®æœ‰ç›¸æ©Ÿã€‚";
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorMessage = "âŒ ç›¸æ©Ÿè¢«ä½”ç”¨æˆ–ç„¡æ³•å•Ÿå‹•ï¼Œè«‹é—œé–‰å…¶ä»–ç¨‹å¼ã€‚";
                } else if (err.name === 'OverconstrainedError') {
                    errorMessage = "âŒ ç›¸æ©Ÿç´„æŸæ¢ä»¶ç„¡æ³•æ»¿è¶³ï¼Œè«‹æª¢æŸ¥ç›¸æ©Ÿè¨­å®šæˆ–å˜—è©¦æ”¾å¯¬è§£æåº¦è¦æ±‚ã€‚";
                } else if (err.name === 'SecurityError') {
                     errorMessage = "âŒ ç¶²é éœ€é€é HTTPS æˆ– localhost é‹è¡Œæ‰èƒ½å•Ÿå‹•ç›¸æ©Ÿã€‚";
                } else if (err.message && err.message.includes("Could not start video source") || err.message.includes("getUserMedia")) {
                    errorMessage = "âŒ å•Ÿå‹•è¦–è¨Šæºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç›¸æ©Ÿæ¬Šé™æˆ–æ˜¯å¦æœ‰å…¶ä»–æ‡‰ç”¨ä½”ç”¨ç›¸æ©Ÿã€‚";
                }
                this.updateStatus(errorMessage, 'error');
                this.isScanning = false;
                this.updateToggleButtonState();
            }

            async stopScan() {
                if (!this.isScanning) return;

                try {
                    Quagga.stop();
                } catch (err) {
                    console.error("åœæ­¢ç›¸æ©Ÿå¤±æ•—:", err);
                    this.updateStatus(`âŒ åœæ­¢ç›¸æ©Ÿå¤±æ•—: ${err.message}`, 'error');
                } finally {
                    this.isScanning = false;
                    this.updateStatus('ğŸ“‹ æƒæå·²åœæ­¢', 'ready');
                    this.updateToggleButtonState();
                    console.log("QuaggaJS2 ç›¸æ©Ÿå·²åœæ­¢ã€‚");
                }
            }

            toggleScan() {
                if (this.isScanning) {
                    this.stopScan();
                } else {
                    this.startScan();
                }
            }

            async rescan() {
                if (this.isScanning) {
                    await this.stopScan();
                }
                this.updateStatus('ğŸ”„ é‡æ–°å•Ÿå‹•æƒæä¸­...', 'info');
                await this.startScan();
            }
            
            playBeep() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (e) {
                    console.warn("ç„¡æ³•æ’­æ”¾æç¤ºéŸ³:", e);
                }
            }

            handleVisibilityChange() {
                if (document.hidden && this.isScanning) {
                    this.stopScan();
                    this.updateStatus('é é¢å·²åˆ‡æ›ï¼Œæƒæè‡ªå‹•åœæ­¢', 'info');
                }
            }

            // === æƒæçµæœç®¡ç†åŠŸèƒ½ ===

            addResultToDisplay(text, format) {
                const newResult = {
                    id: this.nextResultId++,
                    text: text,
                    format: format,
                    timestamp: new Date().toLocaleString()
                };
                this.results.push(newResult);
                this.saveResultsToLocalStorage();
                this.renderResults();
            }

            deleteResult(id) {
                this.results = this.results.filter(result => result.id !== id);
                this.saveResultsToLocalStorage();
                this.renderResults();
            }

            clearAllResults() {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æƒæçµæœå—ï¼Ÿ')) {
                    this.results = [];
                    this.saveResultsToLocalStorage();
                    this.renderResults();
                    this.updateStatus('æ‰€æœ‰æƒæçµæœå·²æ¸…é™¤', 'info');
                }
            }

            renderResults() {
                this.scannedResultsList.innerHTML = '';
                if (this.results.length === 0) {
                    const noResultItem = document.createElement('li');
                    noResultItem.style.textAlign = 'center';
                    noResultItem.style.color = '#888';
                    noResultItem.textContent = 'æš«ç„¡æƒæçµæœ';
                    this.scannedResultsList.appendChild(noResultItem);
                    this.clearAllBtn.disabled = true;
                } else {
                    this.clearAllBtn.disabled = false;
                    this.results.forEach(result => {
                        const listItem = document.createElement('li');
                        listItem.className = 'result-item';
                        listItem.dataset.id = result.id;

                        listItem.innerHTML = `
                            <div class="content">
                                <strong>${result.text}</strong>
                                <span>æ ¼å¼: ${result.format} | ${result.timestamp}</span>
                            </div>
                            <button class="delete-btn">âœ–</button>
                        `;

                        const deleteButton = listItem.querySelector('.delete-btn');
                        deleteButton.addEventListener('click', () => this.deleteResult(result.id));

                        this.scannedResultsList.appendChild(listItem);
                    });
                }
            }

            saveResultsToLocalStorage() {
                localStorage.setItem('scannedBarcodes', JSON.stringify(this.results));
                localStorage.setItem('nextResultId', this.nextResultId.toString());
            }

            loadResultsFromLocalStorage() {
                const storedResults = localStorage.getItem('scannedBarcodes');
                const storedNextId = localStorage.getItem('nextResultId');
                if (storedResults) {
                    this.results = JSON.parse(storedResults);
                    this.nextResultId = storedNextId ? parseInt(storedNextId, 10) : (this.results.length > 0 ? Math.max(...this.results.map(r => r.id)) + 1 : 0);
                } else {
                    this.results = [];
                    this.nextResultId = 0;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const scannerApp = new BarcodeScannerApp();
            scannerApp.startScan();
        });
    </script>
</body>
</html>
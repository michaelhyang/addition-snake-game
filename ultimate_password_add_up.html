<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµ‚æ¥µå¯†ç¢¼ï¼ˆè¸©é›·ç´¯åŠ ç‰ˆï¼‰ğŸ’£</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Reset å’ŒåŸºç¤æ¨£å¼ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-text-size-adjust: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Creamy Gray Theme Color Variables --- */
        :root {
            --primary-color: #6CB652;   /* æŸ”å’Œçš„ç¶ è‰²ï¼Œä¸»è¦æ“ä½œè‰² */
            --secondary-color: #4AA0E6; /* æŸ”å’Œçš„è—è‰²ï¼Œæ¬¡è¦å¼·èª¿è‰² */
            --accent-color: #FF7043;    /* æŸ”å’Œçš„æ©˜ç´…è‰²ï¼Œè­¦ç¤ºæˆ–é«˜äº® */
            --warning-color: #FFD25B;   /* æŸ”å’Œçš„é»ƒè‰²ï¼Œè­¦å‘Šè‰² */
            --danger-color: #E55959;    /* æŸ”å’Œçš„ç´…è‰²ï¼Œå¤±æ•—æˆ–è­¦å‘Š */

            --page-bg: #EAE3DA;         /* é é¢æ•´é«”èƒŒæ™¯ */
            --game-bg-1: #F6F1E7;       /* éŠæˆ²å…§éƒ¨ä¸»è¦èƒŒæ™¯ */
            --game-bg-2: #F8F4ED;       /* éŠæˆ²å…§éƒ¨æ¬¡è¦èƒŒæ™¯ï¼Œç”¨æ–¼æ ¼å­ */
            --disabled-bg: #EFEBE5;     /* ç¦ç”¨ç‹€æ…‹çš„èƒŒæ™¯ */

            --text-color-dark: #333333;  /* è¼ƒæ·±çš„æ–‡å­—ï¼Œç”¨æ–¼ä¸»è¦å…§å®¹ */
            --text-color-medium: #5A6B78; /* ä¸­ç­‰æ·±è‰²æ–‡å­—ï¼Œç”¨æ–¼æ¬¡è¦å…§å®¹ */
            --text-color-light-on-dark: #FFFFFF; /* åœ¨æ·±è‰²èƒŒæ™¯ä¸Šçš„æ·ºè‰²æ–‡å­— */

            --border-color-creamy: #D0D0BE; /* å¥¶æ²¹è‰²ç³»é‚Šæ¡†ï¼Œæ¯”èƒŒæ™¯ç¨æ·± */
            --shadow-creamy: 0 4px 15px rgba(0, 0, 0, 0.08); /* æŸ”å’Œé™°å½± */
            --shadow-hover-creamy: 0 6px 20px rgba(0, 0, 0, 0.12); /* æŸ”å’Œhoveré™°å½± */

            /* --- ç©å®¶é¡è‰²è®Šæ•¸ (ä¿æŒé®®è±”ä»¥å€åˆ†ç©å®¶) --- */
            --player1-color: #64B5F6; /* ç©å®¶1 äº®è—è‰² */
            --player2-color: #FFB74D; /* ç©å®¶2 äº®æ©˜é»ƒè‰² */
            --player3-color: #81C784; /* ç©å®¶3 äº®ç¶ è‰² */
            --player4-color: #E57373; /* ç©å®¶4 äº®ç´…è‰² */
            --player5-color: #BA68C8; /* ç©å®¶5 ç´«è‰² */
            --player6-color: #C0CA33; /* ç©å®¶6 æª¸æª¬ç¶  */
            --text-color-on-player-color: #FFFFFF; /* ç©å®¶é¸ä¸­æ ¼å­ä¸Šçš„æ–‡å­—é¡è‰² */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            background-color: var(--page-bg); /* é é¢æ•´é«”èƒŒæ™¯ */
            padding: 8px;
            color: var(--text-color-dark); /* æ·±è‰²æ–‡å­— */
            line-height: 1.4;
        }

        .game-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 400px; /* é‡å°æ‰‹æ©Ÿä¿æŒæœ€å¤§å¯¬åº¦ */
            margin-top: 10px;
            gap: 12px;
        }

        .game-info-and-board-container {
            background-color: var(--game-bg-1); /* éŠæˆ²å…§éƒ¨ä¸»è¦èƒŒæ™¯ (å¥¶æ²¹ç°) */
            padding: 12px;
            border-radius: 16px;
            box-shadow: var(--shadow-creamy);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .game-info-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .game-info-content > *:not(:last-child) {
            margin-bottom: 8px;
        }
        h1 { margin-bottom: 10px !important; color: var(--primary-color); }
        .instructions { margin-bottom: 15px !important; color: var(--text-color-medium); }
        .game-stats-row { margin-bottom: 15px !important; }
        .message.active, .lose-message.active { margin-bottom: 10px !important; }

        .game-stats .stat-item:first-child {
            margin-bottom: 8px;
        }

        #gameBoard {
            margin-top: 15px;
            border-collapse: collapse;
            width: 100%;
            border: 2px solid var(--border-color-creamy); /* å¥¶æ²¹è‰²ç³»é‚Šæ¡† */
            table-layout: fixed;
            border-radius: 8px;
            overflow: hidden;
        }

        .game-settings-container {
            background-color: var(--game-bg-1); /* éŠæˆ²å…§éƒ¨ä¸»è¦èƒŒæ™¯ (å¥¶æ²¹ç°) */
            padding: 20px 25px;
            border-radius: 16px;
            box-shadow: var(--shadow-creamy);
            flex-shrink: 0;
            text-align: center;
            margin-top: 15px;
        }
        .game-settings-container h2 { margin-bottom: 15px; color: var(--secondary-color); }
        .game-settings-container .settings-grid {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .setting-item label {
            font-size: 0.95em;
            color: var(--text-color-dark); /* æ·±è‰²æ–‡å­— */
            font-weight: 500;
        }

        .setting-item input {
            padding: 6px 10px;
            border: 1px solid var(--border-color-creamy); /* å¥¶æ²¹è‰²ç³»é‚Šæ¡† */
            background-color: var(--game-bg-2); /* æ›´æ·ºçš„å¥¶æ²¹è‰² */
            color: var(--text-color-dark); /* æ·±è‰²æ–‡å­— */
            border-radius: 8px;
            font-size: 0.9em;
            width: 70px;
            text-align: center;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .setting-item input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(74, 160, 230, 0.3);
        }

        .start-game-button {
            background-color: var(--primary-color);
            color: var(--text-color-light-on-dark); /* ç™½è‰²æ–‡å­— */
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: var(--shadow-creamy);
        }

        .start-game-button:hover {
            background-color: #7BC765;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover-creamy);
        }
        .start-game-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .game-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            min-width: 95px;
            flex-shrink: 0;
            margin-bottom: 12px;
        }

        .stat-item {
            font-size: 1em;
            font-weight: bold;
            display: flex;
            align-items: baseline;
            gap: 5px;
            line-height: 1.2;
            color: var(--text-color-dark); /* æ·±è‰²æ–‡å­— */
        }
        .stat-item .stat-value {
            font-size: 1.3em;
        }
        .current-range .stat-value {
            color: var(--accent-color);
        }
        .player-turn .stat-value {
            color: var(--secondary-color);
        }
        .player-turn-color-1 { color: var(--player1-color) !important; }
        .player-turn-color-2 { color: var(--player2-color) !important; }
        .player-turn-color-3 { color: var(--player3-color) !important; }
        .player-turn-color-4 { color: var(--player4-color) !important; }
        .player-turn-color-5 { color: var(--player5-color) !important; }
        .player-turn-color-6 { color: var(--player6-color) !important; }

        .last-guess-info {
            font-size: 1em;
            font-weight: bold;
            color: var(--secondary-color);
            flex-grow: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.3s ease;
            transform: scale(1);
            margin-top: 5px;
        }
        .last-guess-info.active-pulse {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        .message {
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
            line-height: 1.3;
            display: none;
            min-height: 0;
            padding: 4px 0;
            color: var(--warning-color);
        }
        .message.active {
            display: block;
        }
        .lose-message {
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            line-height: 1.3;
            display: none;
            min-height: 0;
            padding: 8px 0;
            color: var(--danger-color);
        }
        .lose-message.active {
            display: block;
        }
        .reset-button {
            background-color: var(--primary-color);
            color: var(--text-color-light-on-dark); /* ç™½è‰²æ–‡å­— */
            margin-top: 12px;
            padding: 8px 15px;
            font-size: 0.95em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        .reset-button:hover {
            background-color: #FFDE7A;
            transform: translateY(-1px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }
        .reset-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.08);
        }

        /* Game Board Styles */
        #gameBoard td {
            width: 10%;
            height: 35px;
            min-height: 35px;
            max-height: 35px;
            border: 1px solid var(--border-color-creamy); /* å¥¶æ²¹è‰²ç³»é‚Šæ¡† */
            text-align: center;
            vertical-align: middle;
            font-size: 0.75em;
            font-weight: bold;
            color: var(--text-color-dark); /* æ·±è‰²æ–‡å­— */
            background-color: var(--game-bg-2); /* æ›´æ·ºçš„å¥¶æ²¹è‰² */
            transition: background-color 0.3s ease, transform 0.1s ease, color 0.3s ease;
            cursor: pointer;
            position: relative;
            line-height: 1.2;
        }
        #gameBoard td:hover:not(.disabled):not(.player-selected) {
            background-color: #F0F0E0; /* æŸ”å’Œçš„hoverèƒŒæ™¯ */
        }
        #gameBoard td.disabled {
            background-color: var(--disabled-bg); /* ç¦ç”¨èƒŒæ™¯ */
            color: var(--text-color-medium); /* ä¸­ç­‰æ·±è‰²æ–‡å­— */
            cursor: not-allowed;
            pointer-events: none;
            opacity: 0.7;
        }
        #gameBoard td.player-selected {
            color: var(--text-color-on-player-color); /* ç™½è‰²æ–‡å­— */
            transform: scale(0.9);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            pointer-events: none;
            transition: background-color 0.1s ease, transform 0.1s ease, color 0.1s ease, box-shadow 0.1s ease;
        }

        /* ç©å®¶é¡è‰²å°æ‡‰ */
        #gameBoard td.player-1 { background-color: var(--player1-color); }
        #gameBoard td.player-2 { background-color: var(--player2-color); }
        #gameBoard td.player-3 { background-color: var(--player3-color); }
        #gameBoard td.player-4 { background-color: var(--player4-color); }
        #gameBoard td.player-5 { background-color: var(--player5-color); }
        #gameBoard td.player-6 { background-color: var(--player6-color); }

        /* å¦‚æœçŒœä¸­åœ°é›·ï¼Œæ•¸å­—è®Šç´…è‰²ä¸¦é¡¯ç¤ºç‚¸å½ˆ */
        #gameBoard td.mine-hit {
            background-color: red;
            color: red; /* å°‡æ–‡å­—é¡è‰²ç›´æ¥è¨­ç‚ºç´…è‰²ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è®Šæ•¸ï¼Œä»¥ç¬¦åˆæ‚¨çš„æœŸæœ› */
            font-size: 1.1em;
            animation: pulse-red 0.5s ease-in-out 3;
            display: flex;
            box-sizing: border-box;
            align-items: flex-end;
        }
        #gameBoard td.mine-hit .bomb-icon {
            font-size: 1.2em;
            line-height: 1;
            display: block;
            width: 100%;
            box-sizing: border-box;
        }
        #gameBoard td.mine-hit sub {
            font-size: 0.6em;
            line-height: 1;
            display: block;
            width: 100%;
            text-align: right;
        }

        /* ç‚¸å½ˆå‹•ç•«é—œéµå½±æ ¼ */
        @keyframes pulse-red {
            0% { transform: scale(0.8); opacity: 0.8; background-color: #FFEB3B; }
            50% { transform: scale(1.1); opacity: 1; background-color: #FFEB3B; }
            100% { transform: scale(1); opacity: 1; background-color: #FFEB3B; }
        }

        #gameBoard td span {
             display: flex;
             width: 100%;
             height: 100%;
             justify-content: center;
             align-items: center;
             padding: 0;
             box-sizing: border-box;
             line-height: inherit;
             font-size: inherit;
        }

        /* æ¡Œé¢ç«¯èª¿æ•´ */
        @media (min-width: 768px) {
            body {
                padding: 20px;
                line-height: 1.5;
            }
            .game-wrapper {
                max-width: 650px;
                margin-top: 20px;
                gap: 15px;
            }
            .game-info-and-board-container {
                padding: 20px;
                border-radius: 20px;
            }
            .game-settings-container {
                padding: 25px 30px;
                border-radius: 20px;
                margin-top: 20px;
            }

            .game-info-content > *:not(:last-child) {
                margin-bottom: 10px;
            }
            h1 { font-size: 2.2em; margin-bottom: 12px !important; }
            .instructions { font-size: 0.95em; line-height: 1.6; margin-bottom: 20px !important; }
            .game-stats-row { padding: 0 15px; margin-bottom: 20px !important; }
            #gameBoard { margin-top: 20px; max-width: 450px; }
            #gameBoard td { height: 45px !important; min-height: 45px !important; max-height: 45px !important;}

            .game-settings-container h2 { margin-bottom: 18px; }
            .game-settings-container .settings-grid { margin-bottom: 25px; gap: 15px; }
            .setting-item label { font-size: 1.05em; }
            .setting-item input { padding: 8px 12px; width: 80px; font-size: 1em;}
            .start-game-button { padding: 12px 25px; font-size: 1.1em; }

            .game-stats { gap: 5px; min-width: 120px;
                margin-bottom: 15px;
            }
            .stat-item { font-size: 1.1em; gap: 6px; }
            .stat-item .stat-value { font-size: 1.4em; }
            .last-guess-info { font-size: 0.95em; line-height: 1.4; }
            .message { font-size: 1em; padding: 6px 0; line-height: 1.4;}
            .lose-message { font-size: 1.2em; padding: 10px 0; }
            .reset-button { margin-top: 15px; padding: 10px 18px; font-size: 1em; }

            #gameBoard td.mine-hit .bomb-icon {
                font-size: 1.5em;                
            }
            #gameBoard td.mine-hit sub {
                font-size: 0.7em;
            }
        }

        /* é‡å° iOS Safari çš„ç‰¹æ®Šè™•ç† */
        @supports (-webkit-overflow-scrolling: touch) {
            body { -webkit-text-size-adjust: 100%; }
            #gameBoard {
                width: calc(100% - 24px) !important;
            }
            #gameBoard td {
                height: 35px !important;
                min-height: 35px !important;
                max-height: 35px !important;
            }
            input[type="number"] {
                -webkit-appearance: none;
                -moz-appearance: textfield;
                appearance: none;
            }
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div class="game-info-and-board-container" id="gameInfoAndBoardSection" style="display: none;">
            <div class="game-info-content">
                <h1>çµ‚æ¥µå¯†ç¢¼ï¼ˆè¸©é›·æ­¥é€²ç‰ˆï¼‰ğŸ’£</h1>
                <p class="instructions">ç©å®¶è¼ªæµå¾è¡¨æ ¼ä¸­é¸æ“‡ä¸€å€‹æ•¸å­—ã€‚æ¯æ¬¡é¸æ“‡çš„æ•¸å­—å¿…é ˆæ¯”ä¸Šä¸€å€‹æ•¸å­—å¤§ï¼Œä¸”æœ€å¤šåªèƒ½å¤§ 3 ä½æ•¸ã€‚å°å¿ƒï¼çŒœä¸­ã€Œçµ‚æ¥µå¯†ç¢¼ã€çš„ç©å®¶å°±æœƒè¼¸ï¼</p>

                <div class="game-stats-row">
                    <div class="game-stats">
                        <div class="stat-item current-range">ä¸‹ä¸€æ­¥ç¯„åœ: <span class="stat-value" id="nextRangeDisplay">1 - 3</span></div>
                        <div class="stat-item player-turn">è¼ªåˆ°: <span class="stat-value" id="playerTurn">ç©å®¶ 1</span></div>
                    </div>
                    <p class="last-guess-info" id="lastGuessInfo">è«‹é¸æ“‡æ•¸å­—ï¼Œå¾ 1 é–‹å§‹ï¼</p>
                </div>

                <p class="message" id="gameMessage"></p>
                <p class="lose-message" id="loseMessage"></p> <button class="reset-button" onclick="resetGame()" style="display: none;">é‡æ–°é–‹å§‹</button>
            </div>

            <table id="gameBoard"></table>
        </div>

        <div class="game-settings-container" id="gameSettingsSection">
            <h2>éŠæˆ²è¨­å®š</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="maxNumberInput">æœ€å¤§å¯é¸æ•¸å­—:</label>
                    <input type="number" id="maxNumberInput" min="10" value="30"> </div>
                <div class="setting-item">
                    <label for="numPlayersInput">ç©å®¶äººæ•¸:</label>
                    <input type="number" id="numPlayersInput" min="2" max="6" value="2">
                </div>
            </div>
            <button class="start-game-button" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
        </div>
    </div>

    <script>
        let maxNumber = 30; // åˆå§‹é è¨­æœ€å¤§å¯é¸æ•¸å­—ï¼Œå·²ä¿®æ”¹ç‚º30
        let numPlayers = 2;  // åˆå§‹é è¨­ç©å®¶äººæ•¸
        let secretNumber = 0; // çµ‚æ¥µå¯†ç¢¼ (è¸©ä¸­è€…è¼¸)
        let lastGuessedNumber = 0; // ä¸Šä¸€å€‹ç©å®¶çŒœçš„æ•¸å­—ï¼Œåˆå§‹ç‚º 0 å…è¨±å¾ 1,2,3 é–‹å§‹é¸

        let playerTurn = 1;

        const maxNumberInput = document.getElementById('maxNumberInput');
        const numPlayersInput = document.getElementById('numPlayersInput');
        const startGameButton = document.querySelector('button.start-game-button');
        const gameSettingsSection = document.getElementById('gameSettingsSection');
        const gameInfoAndBoardSection = document.getElementById('gameInfoAndBoardSection');

        const gameBoard = document.getElementById('gameBoard');
        const nextRangeDisplay = document.getElementById('nextRangeDisplay'); // é¡¯ç¤ºä¸‹ä¸€æ­¥å¯é¸ç¯„åœ
        const playerTurnDisplay = document.getElementById('playerTurn');
        const lastGuessInfoDisplay = document.getElementById('lastGuessInfo'); // æç¤ºæ–‡å­—
        const gameMessageDisplay = document.getElementById('gameMessage');     // éŒ¯èª¤/è­¦å‘Šè¨Šæ¯
        const loseMessageDisplay = document.getElementById('loseMessage');       // è½æ•—è¨Šæ¯
        const resetButton = document.querySelector('.reset-button');

        // --- Helper function for message display ---
        function showMessage(element, text) {
            element.textContent = text;
            element.classList.add('active');
        }

        function hideMessage(element) {
            element.textContent = '';
            element.classList.remove('active');
        }

        // å‡½æ•¸ä¾†æ›´æ–°æç¤ºæ–‡å­—ä¸¦è§¸ç™¼å‹•ç•«
        function updateLastGuessInfo(text) {
            lastGuessInfoDisplay.textContent = text;
            lastGuessInfoDisplay.classList.remove('active-pulse');
            void lastGuessInfoDisplay.offsetWidth; // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª
            lastGuessInfoDisplay.classList.add('active-pulse');
        }

        // --- Game Logic ---
        function generateSecretNumber() {
            const minPossibleSecret = Math.max(1, Math.floor(maxNumber * 0.25));
            const maxPossibleSecret = Math.floor(maxNumber * 0.99);

            if (minPossibleSecret > maxPossibleSecret) {
                secretNumber = Math.max(1, Math.floor(maxNumber * 0.8));
            } else {
                secretNumber = Math.floor(Math.random() * (maxPossibleSecret - minPossibleSecret + 1)) + minPossibleSecret;
            }
            console.log("Secret Number (for debug):", secretNumber);
        }

        function createGameBoard() {
            gameBoard.innerHTML = '';
            const cellsPerRow = 10;
            const numRows = Math.ceil(maxNumber / cellsPerRow);

            for (let i = 0; i < numRows; i++) {
                const row = gameBoard.insertRow();
                for (let j = 0; j < cellsPerRow; j++) {
                    const cell = row.insertCell();
                    const num = i * cellsPerRow + j + 1;

                    if (num <= maxNumber) {
                        cell.setAttribute('data-value', num);
                        cell.innerHTML = `<span>${num}</span>`; // åˆå§‹é¡¯ç¤ºæ•¸å­—
                        cell.onclick = () => handleGuess(num, cell);
                    } else {
                        cell.style.visibility = 'hidden';
                        cell.innerHTML = '';
                        cell.onclick = null;
                    }
                }
            }
            updateBoardState();
        }

        function updateBoardState() {
            const allCells = gameBoard.querySelectorAll('td');
            const minValidNumber = lastGuessedNumber + 1;
            const maxValidNumber = Math.min(lastGuessedNumber + 3, maxNumber);

            allCells.forEach(cell => {
                const num = parseInt(cell.getAttribute('data-value'));
                const isPlayerSelected = cell.classList.contains('player-selected');
                const isMineHitCell = cell.classList.contains('mine-hit'); // æ–°å¢æª¢æŸ¥æ˜¯å¦ç‚ºç‚¸å½ˆæ ¼å­

                // å¦‚æœæ˜¯ç‚¸å½ˆæ ¼å­ï¼Œå‰‡æ°¸é ä¿æŒå…¶ç‹€æ…‹ï¼Œä¸é‡æ–°å•Ÿç”¨
                if (isMineHitCell) {
                    cell.classList.add('disabled');
                    cell.onclick = null;
                    return; // è·³éå¾ŒçºŒçš„å•Ÿç”¨/ç¦ç”¨é‚è¼¯
                }

                if (!isNaN(num) && num >= minValidNumber && num <= maxValidNumber && !isPlayerSelected) {
                    cell.classList.remove('disabled');
                    cell.onclick = () => handleGuess(num, cell);
                } else if (!isPlayerSelected) {
                    cell.classList.add('disabled');
                    cell.onclick = null;
                }
            });

            if (minValidNumber > maxNumber) {
                nextRangeDisplay.textContent = "ç„¡å¯é¸";
            } else {
                nextRangeDisplay.textContent = `${minValidNumber} - ${maxValidNumber}`;
            }
        }

        function handleGuess(guess, cell) {
            hideMessage(gameMessageDisplay);
            hideMessage(loseMessageDisplay);

            const minValidNumber = lastGuessedNumber + 1;
            const maxValidNumber = Math.min(lastGuessedNumber + 3, maxNumber);

            if (guess < minValidNumber || guess > maxValidNumber) {
                showMessage(gameMessageDisplay, `ç©å®¶ ${playerTurn} é¸æ“‡ ${guess}ã€‚ç„¡æ•ˆï¼è«‹é¸æ“‡ä¸€å€‹ä»‹æ–¼ ${minValidNumber} åˆ° ${maxValidNumber} çš„æ•¸å­—ã€‚`);
                return;
            }

            let isMineHit = false;
            // åˆ¤æ–·æ•´å€‹é¸æ“‡ç¯„åœæ˜¯å¦åŒ…å« secretNumber
            if (secretNumber >= minValidNumber && secretNumber <= guess) {
                isMineHit = true;
            }

            for (let i = minValidNumber; i <= guess; i++) {
                const targetCell = gameBoard.querySelector(`td[data-value="${i}"]`);
                if (targetCell) {
                    targetCell.classList.remove('selected');
                    // ç¢ºä¿ç§»é™¤æ‰€æœ‰ player-X é¡ï¼Œé˜²æ­¢å¤šå€‹é¡æ®˜ç•™
                    for (let p = 1; p <= numPlayers; p++) {
                        targetCell.classList.remove(`player-${p}`);
                    }
                    targetCell.classList.add('player-selected', `player-${playerTurn}`);
                    targetCell.classList.add('disabled');
                    targetCell.onclick = null;

                    if (isMineHit && i === secretNumber) {
                        targetCell.classList.add('mine-hit');
                        // é¡¯ç¤ºç‚¸å½ˆåœ–ç¤ºå’Œæ•¸å­—
                        targetCell.innerHTML = `<span class="bomb-icon">ğŸ’£</span><sub>${secretNumber}</sub>`;
                    } else { // æ­£å¸¸è¢«é¸ä¸­çš„æ•¸å­—
                        targetCell.classList.remove('mine-hit'); // ç§»é™¤å¯èƒ½çš„mine-hité¡
                        targetCell.innerHTML = `<span>${i}</span>`;
                    }
                }
            }

            lastGuessedNumber = guess;

            if (isMineHit) {
                showMessage(loseMessageDisplay, `ç©å®¶ ${playerTurn} çŒœä¸­äº†çµ‚æ¥µå¯†ç¢¼ ${secretNumber}ï¼ä½ è¼¸äº†ï¼ğŸ˜­`);
                updateLastGuessInfo(`ç©å®¶ ${playerTurn} è¸©åˆ°åœ°é›·ï¼ŒéŠæˆ²çµæŸï¼`);
                disableAllCells();
                resetButton.style.display = 'block';
                return;
            }

            updateLastGuessInfo(`ç©å®¶ ${playerTurn} é¸æ“‡åˆ° ${guess}ã€‚`);
            updateBoardState(); // æ›´æ–°æ£‹ç›¤ç‹€æ…‹

            const nextMinValid = lastGuessedNumber + 1;
            if (nextMinValid > maxNumber) {
                showMessage(loseMessageDisplay, `æ²’æœ‰å¯é¸çš„æ•¸å­—äº†ã€‚çµ‚æ¥µå¯†ç¢¼æ˜¯ ${secretNumber}ã€‚æ‰€æœ‰ç©å®¶éƒ½å®‰å…¨ï¼`);
                updateLastGuessInfo(`éŠæˆ²çµæŸã€‚çµ‚æ¥µå¯†ç¢¼æ˜¯ ${secretNumber}ã€‚`);
                disableAllCells();
                resetButton.style.display = 'block';
                return;
            }

            playerTurn = (playerTurn % numPlayers) + 1;
            updatePlayerTurnDisplay(); // æ›´æ–°ç©å®¶è¼ªæ¬¡é¡¯ç¤º

            const nextMaxValid = Math.min(lastGuessedNumber + 3, maxNumber);
            updateLastGuessInfo(`è¼ªåˆ°ç©å®¶ ${playerTurn}ã€‚è«‹é¸æ“‡ä¸€å€‹ä»‹æ–¼ ${nextMinValid} åˆ° ${nextMaxValid} çš„æ•¸å­—ã€‚`);
        }

        function disableAllCells() {
            gameBoard.querySelectorAll('td').forEach(cell => {
                cell.classList.add('disabled');
                cell.onclick = null;
            });
        }

        // --- ä¿®æ­£å¾Œçš„å‡½æ•¸ï¼šæ›´æ–°ç©å®¶è¼ªæ¬¡é¡¯ç¤ºçš„é¡è‰² ---
        function updatePlayerTurnDisplay() {
            // ç§»é™¤æ‰€æœ‰èˆŠçš„é¡è‰²é¡
            for (let i = 1; i <= 6; i++) { // å‡è¨­æœ€å¤š6å€‹ç©å®¶
                playerTurnDisplay.classList.remove(`player-turn-color-${i}`);
            }
            // æ·»åŠ ç•¶å‰ç©å®¶çš„é¡è‰²é¡
            playerTurnDisplay.classList.add(`player-turn-color-${playerTurn}`);
            playerTurnDisplay.textContent = `ç©å®¶ ${playerTurn}`;
        }

        function updateGameDisplay() {
            updatePlayerTurnDisplay(); // åˆå§‹åŒ–æ™‚ä¹Ÿå‘¼å«
            const initialMin = lastGuessedNumber + 1;
            const initialMax = Math.min(lastGuessedNumber + 3, maxNumber);
            nextRangeDisplay.textContent = `${initialMin} - ${initialMax}`;
            updateLastGuessInfo('è«‹é¸æ“‡æ•¸å­—ï¼Œå¾ 1 é–‹å§‹ï¼');
            hideMessage(gameMessageDisplay);
            hideMessage(loseMessageDisplay);
            resetButton.style.display = 'none';
        }

        function resetGame() {
            maxNumber = parseInt(maxNumberInput.value);
            numPlayers = parseInt(numPlayersInput.value);

            lastGuessedNumber = 0;
            playerTurn = 1;

            generateSecretNumber();

            updateGameDisplay();
            createGameBoard(); // é‡æ–°ç¹ªè£½æ£‹ç›¤ä»¥æ¸…é™¤é¡è‰²å’Œç‹€æ…‹

            gameSettingsSection.style.display = 'block';
            gameInfoAndBoardSection.style.display = 'none';

            maxNumberInput.disabled = false;
            numPlayersInput.disabled = false;
            startGameButton.disabled = false;
        }

        function startGame() {
            const enteredMaxNumber = parseInt(maxNumberInput.value);
            const enteredNumPlayers = parseInt(numPlayersInput.value);

            if (isNaN(enteredMaxNumber) || enteredMaxNumber < 10) {
                showMessage(gameMessageDisplay, "æœ€å¤§å¯é¸æ•¸å­—è‡³å°‘è¦ 10ï¼");
                return;
            }
            if (isNaN(enteredNumPlayers) || enteredNumPlayers < 2 || enteredNumPlayers > 6) {
                showMessage(gameMessageDisplay, "ç©å®¶äººæ•¸è«‹è¼¸å…¥ 2 åˆ° 6 ä¹‹é–“ï¼");
                return;
            }

            maxNumber = enteredMaxNumber;
            numPlayers = enteredNumPlayers;

            lastGuessedNumber = 0;
            playerTurn = 1;

            generateSecretNumber();

            gameSettingsSection.style.display = 'none';
            gameInfoAndBoardSection.style.display = 'flex';

            maxNumberInput.disabled = true;
            numPlayersInput.disabled = true;
            startGameButton.disabled = true;

            createGameBoard();
            updateGameDisplay(); // åˆå§‹åŒ–é¡¯ç¤ºå…§å®¹
        }

        // Initial setup when page loads
        gameInfoAndBoardSection.style.display = 'none';
        gameSettingsSection.style.display = 'block';

        // åˆå§‹è¼‰å…¥æ™‚é¡¯ç¤ºç¯„åœçš„é è¨­æç¤º
        nextRangeDisplay.textContent = `1 - 3`;
    </script>
</body>
</html>
